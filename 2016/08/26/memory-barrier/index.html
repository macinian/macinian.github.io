<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Memory Barrier | Words of MaciNian</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Memory Barrier</h1><a id="logo" href="/.">Words of MaciNian</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Memory Barrier</h1><div class="post-meta">Aug 26, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><blockquote>
<p>本周陆续看了两篇关于Memory Barrier的文章，记录一下自己目前对其的理解。</p>
</blockquote>
<h2 id="1-Memory-Barriers-Fences"><a href="#1-Memory-Barriers-Fences" class="headerlink" title="1. Memory Barriers/Fences"></a>1. Memory Barriers/Fences</h2><p>第一篇是Martin Thompson的<a href="http://mechanical-sympathy.blogspot.com/2011/07/memory-barriersfences.html" target="_blank" rel="external">Memory Barriers/Fences</a>。<br>这篇文章对<code>memory barrier</code>与<code>store/load buffer</code>之间的关系，以及<code>memory barrier</code>的作用进行了简单而清晰的讲解，原文描述和个人的主要理解如下：  </p>
<h3 id="Store-barrier"><a href="#Store-barrier" class="headerlink" title="Store barrier"></a>Store barrier</h3><blockquote>
<p>A store barrier, “sfence” instruction on x86, waits for all store instructions prior to the barrier to be written from the store buffer to the L1 cache for the CPU on which it is issued. This will make the program state visible to other CPUs so they can act on it if necessary.  </p>
</blockquote>
<p>CPU和内存之间的性能差距非常大，因此有了多级cache的结构。然而<code>cache coherency</code>（保证多个CPU的缓存一致性）带来的性能开销也不容小觑，因此CPU并不是每一次store操作都直接往cache写，而只是写到当前CPU的<code>store buffer</code>中，表现出对其他CPU不可见的现象。<br>所有在<code>store barrier</code>之前store指令从当前CPU的<code>store buffer</code>中写入到cache系统中。这使得当前程序状态（当前CPU在<code>store barrier</code>之前的写操作）对其他CPU可见。  </p>
<h3 id="Load-barrier"><a href="#Load-barrier" class="headerlink" title="Load barrier"></a>Load barrier</h3><blockquote>
<p>A load barrier, “lfence” instruction on x86, ensures all load instructions after the barrier to happen after the barrier and then wait on the load buffer to drain for the issuing CPU.  This makes program state exposed from other CPUs visible to this CPU before making further progress.</p>
</blockquote>
<p>CPU为了发挥其性能会进行指令重排序，会做一些”预测性的load”，比如预先执行一些load指令把结果暂存于当前CPU的<code>load buffer</code>中，那么就可能导致其他CPU的一些store操作，由于相应的变量被预先load，表现出对当前CPU不可见的现象。<br>所有在<code>load barrier</code>之后的load指令会等待<code>load buffer</code>被排空，相当于保证了这些load指令的顺序，发生在barrier之后而不是预先load的结果。这使得其他CPU的写操作（程序状态的改变）对当前CPU可见。  </p>
<p>当然另外还有个<code>full barrier</code>，集上述两个barrier的作用于一身。  </p>
<h3 id="2-Why-Memory-Barriers"><a href="#2-Why-Memory-Barriers" class="headerlink" title="2. Why Memory Barriers"></a>2. Why Memory Barriers</h3><p>第二篇是Paul E. McKenney的Why Memory Barriers，原文在作者的<a href="https://www.kernel.org/pub/linux/kernel/people/paulmck/perfbook/perfbook.2016.07.31a.pdf" target="_blank" rel="external">perfbook</a>附录C中。<br>这篇文章一步一步深入浅出地介绍了memory barrier的由来（和题目非常贴切 Why Memory Barriers），阅读其中的了前5节。  </p>
<p><strong>1-2节</strong>，首先引入了一般化的CPU缓存结构，并介绍了缓存一致性（<code>Cache-Coherence Protocols</code>）的重要性，通过MESI协议为例子描绘了其实现的原理；  </p>
<p><strong>3-5节</strong>，但是保持缓存一致性也会带来不小的开销，尤其是在总线上各种MESI消息的传递、相对CPU来说Cache系统的慢速，如果CPU采取盲目等待的姿势，那么这个性能是不能接受的。所以第3节介绍了<code>store buffer</code>，CPU通过引入<code>store buffer</code>来提高性能（减轻总线传递MESI消息负载、缓解CPU与Cache之间的性能差异），但是<code>store buffer</code>的引入会带来内存乱序/可见性问题，因此引出了<code>write memory barrier</code>的作用和原理；第4节也是类似的，先是CPU引入<code>invalidate queue</code>来提升性能，然后这个queue也会导致内存乱序的问题，然后引出了<code>read memory barrier</code>的作用和原理。  </p>
<p><code>write/read memory barrier</code>分别对应第一篇文章中的<code>store/load barrier</code>，其作用和原理是基本一致的，就不再重复提了。  </p>
<h3 id="3-Stack-overflow上的一个问题"><a href="#3-Stack-overflow上的一个问题" class="headerlink" title="3. Stack overflow上的一个问题"></a>3. Stack overflow上的一个问题</h3><p>上述两篇文章讲的有共通的地方，但也有不一致的地方，例如<strong>Why Memory Barriers</strong>中提到的<code>invalidate queue</code>这一概念和<strong>Memory Barriers/Fences</strong>中提到的<code>load buffer</code>其实并不能对应起来，因此在stack overflow上有人提了这样一个问题:  </p>
<blockquote>
<p>can anyone explain what is load buffer and how it’s different from invalidation queues… <a href="http://stackoverflow.com/questions/11105827/what-is-a-store-buffer" target="_blank" rel="external">http://stackoverflow.com/questions/11105827/what-is-a-store-buffer</a>  </p>
</blockquote>
<p>关于CPU、cache以及memory之间各种buffer的概念和区别。然后在回答里面就看到了这样一幕（<strong>没错，你问的那个东西就是哥发明出来的（权威）。</strong>）：<br><img src="/images/20160826_mb_sof_store_buffer.png" alt=""></p>
<p>这场景似曾相识，在之前看过的另一个问题中：<br><img src="/images/20160826_mb_sof_log4j.png" alt=""></p>
<h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h3><p>多看几篇，假以时日英语能力要上天</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://mciiv.me/2016/08/26/memory-barrier/" data-id="cisbxias400000as6y8f6esi3" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Concurrency/">Concurrency</a><a href="/tags/Memory-Barrier/">Memory Barrier</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://mciiv.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Concurrency/" style="font-size: 15px;">Concurrency</a> <a href="/tags/Memory-Barrier/" style="font-size: 15px;">Memory Barrier</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/08/26/memory-barrier/">Memory Barrier</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Words of MaciNian.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>